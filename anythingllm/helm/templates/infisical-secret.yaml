{{- if .Values.infisical.enabled }}
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: {{ include "anythingllm.fullname" . }}-infisical
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "anythingllm.labels" . | nindent 4 }}
spec:
  # Infisical Cloud API endpoint
  hostAPI: {{ .Values.infisical.hostAPI | default "https://app.infisical.com/api" }}
  
  # Sync interval (how often to check for secret changes)
  resyncInterval: {{ .Values.infisical.resyncInterval | default 60 }}
  
  # Authentication configuration
  authentication:
    universalAuth:
      # Reference to Kubernetes secret containing Client ID and Client Secret
      credentialsRef:
        secretName: {{ .Values.infisical.auth.secretName | default "infisical-universal-auth" }}
        secretNamespace: {{ .Release.Namespace }}
      # Scope of secrets to sync
      secretsScope:
        projectSlug: {{ .Values.infisical.projectSlug | required "infisical.projectSlug is required" }}
        envSlug: {{ .Values.infisical.envSlug | default "production" }}
        secretsPath: {{ .Values.infisical.secretsPath | default "/" }}
  
  # Target Kubernetes secret to sync to
  managedSecretReference:
    secretName: {{ .Values.anythingllm.secrets.secretName | default "anythingllm-secrets" }}
    secretNamespace: {{ .Release.Namespace }}
    # Merge with existing secret data (don't overwrite)
    creationPolicy: "Orphan"
{{- end }}
