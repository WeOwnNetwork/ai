name: Auto-Create PR from Maintenance

on:
  push:
    branches:
      - maintenance

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          existing_pr=$(gh pr list --base main --head maintenance --json number --jq '.[0].number')
          
          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists, skipping creation"
            exit 0
          fi
          
          # Create PR body file to avoid YAML parsing issues
          PR_BODY=$(mktemp)
          
          {
            echo "ðŸ¤– Automated Pull Request"
            echo ""
            echo "## ðŸ“‹ Human-in-the-Loop Review Checklist"
            echo ""
            echo "**Review the following before approving this PR:**"
            echo ""
            echo "### Security & Compliance"
            echo "- [ ] All GitHub Copilot AI code review comments addressed"
            echo "- [ ] SOC2/ISO/IEC 42001 compliance requirements validated"
            echo "- [ ] Security best practices followed (no hardcoded secrets, proper RBAC, etc.)"
            echo "- [ ] No sensitive data in commits"
            echo "- [ ] TLS 1.3 configured where applicable"
            echo ""
            echo "### Code Quality & Testing"
            echo "- [ ] Code follows established conventions and style guides"
            echo "- [ ] All automated tests passing"
            echo "- [ ] No breaking changes (or migration plan documented)"
            echo "- [ ] Performance implications assessed"
            echo "- [ ] Error handling adequate"
            echo ""
            echo "### Documentation & Versioning"
            echo "- [ ] Documentation updated (README, CHANGELOG, inline comments)"
            echo "- [ ] Version numbers incremented appropriately"
            echo "- [ ] API changes documented"
            echo "- [ ] Architecture Decision Records (ADRs) created if applicable"
            echo ""
            echo "### Infrastructure & DevOps"
            echo "- [ ] Helm chart best practices followed"
            echo "- [ ] Kubernetes manifests validated (helm lint, kubectl dry-run)"
            echo "- [ ] Docker best practices followed (multi-stage builds, security)"
            echo "- [ ] Resource limits and requests configured"
            echo "- [ ] Deployment tested in staging"
            echo ""
            echo "## ðŸ“ Recent Commits"
            echo ""
            # Show last 5 commits on maintenance branch (handle missing main branch)
            if git rev-parse --verify origin/main >/dev/null 2>&1; then
              git log --oneline --no-decorate -5 maintenance ^origin/main
            else
              git log --oneline --no-decorate -5 maintenance
            fi
            echo ""
            echo "---"
            echo ""
            echo "**ðŸ” Copilot AI Review**: Automated compliance and security validation will run on this PR."
            echo ""
            echo "**ðŸ“š Guidelines**: See \`.github/copilot-instructions.md\` for complete review criteria."
            echo ""
            echo "**Auto-generated by** \`.github/workflows/auto-pr-maintenance.yml\`"
          } > "$PR_BODY"
          
          # Create PR with body file
          gh pr create \
            --base main \
            --head maintenance \
            --title "Auto-PR: Merge maintenance â†’ main" \
            --body-file "$PR_BODY"
          
          # Cleanup
          rm -f "$PR_BODY"
