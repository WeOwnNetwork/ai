name: Auto-Create PR to Main

on:
  push:
    branches:
      - 'maintenance'
      - 'feature/*'
      - 'fix/*'
      - 'docs/*'
      - 'hotfix/*'
      - '!main'
      - '!experimental/*'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Get current branch name
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Check if PR already exists
          existing_pr=$(gh pr list --base main --head "$BRANCH_NAME" --json number --jq '.[0].number')
          
          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists, new commits will be added automatically"
            echo "pr_number=$existing_pr" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create PR body and title files with cleanup trap
          PR_BODY=$(mktemp)
          PR_TITLE=$(mktemp)
          trap 'rm -f "$PR_BODY" "$PR_TITLE"' EXIT
          
          # Generate dynamic title from first commit (relative to main when available)
          TARGET_BRANCH="main"
          if git rev-parse --verify "origin/$TARGET_BRANCH" >/dev/null 2>&1; then
            FIRST_COMMIT=$(git log --format=%s -1 "$BRANCH_NAME" ^"origin/$TARGET_BRANCH")
          else
            FIRST_COMMIT=$(git log --format=%s -1 "$BRANCH_NAME")
          fi
          
          # Fallback if no unique commits are found or subject is empty
          if [ -z "$FIRST_COMMIT" ]; then
            # Determine commit count compared to target branch when possible
            if git rev-parse --verify "origin/$TARGET_BRANCH" >/dev/null 2>&1; then
              COMMIT_COUNT=$(git rev-list --count "$BRANCH_NAME" ^"origin/$TARGET_BRANCH" 2>/dev/null || echo "")
            else
              COMMIT_COUNT=$(git rev-list --count "$BRANCH_NAME" 2>/dev/null || echo "")
            fi
          
            # Use latest commit message on the branch as an additional hint
            LATEST_SUBJECT=$(git log --format=%s -1 "$BRANCH_NAME" 2>/dev/null || echo "")
          
            if [ -n "$LATEST_SUBJECT" ]; then
              FIRST_COMMIT="Merge $BRANCH_NAME into $TARGET_BRANCH - $LATEST_SUBJECT"
            elif [ -n "$COMMIT_COUNT" ]; then
              FIRST_COMMIT="Merge $BRANCH_NAME into $TARGET_BRANCH ($COMMIT_COUNT commits)"
            else
              FIRST_COMMIT="Merge $BRANCH_NAME into $TARGET_BRANCH"
            fi
          fi
          
          # Create title: "Auto-PR: <descriptive subject>"
          echo "Auto-PR: $FIRST_COMMIT" > "$PR_TITLE"
          
          {
            echo "ðŸ¤– Automated Pull Request"
            echo ""
            echo "## ðŸ“‹ Human-in-the-Loop Review Checklist"
            echo ""
            echo "**Review the following before approving this PR:**"
            echo ""
            echo "### Security & Compliance"
            echo "- [ ] All GitHub Copilot AI code review comments addressed"
            echo "- [ ] SOC2/ISO/IEC 42001 compliance requirements validated"
            echo "- [ ] Security best practices followed (no hardcoded secrets, proper RBAC, etc.)"
            echo "- [ ] No sensitive data in commits"
            echo "- [ ] TLS 1.3 configured where applicable"
            echo ""
            echo "### Code Quality & Testing"
            echo "- [ ] Code follows established conventions and style guides"
            echo "- [ ] All automated tests passing"
            echo "- [ ] No breaking changes (or migration plan documented)"
            echo "- [ ] Performance implications assessed"
            echo "- [ ] Error handling adequate"
            echo ""
            echo "### Documentation & Versioning"
            echo "- [ ] Documentation updated (README, CHANGELOG, inline comments)"
            echo "- [ ] Version numbers incremented appropriately"
            echo "- [ ] API changes documented"
            echo "- [ ] Architecture Decision Records (ADRs) created if applicable"
            echo ""
            echo "### Infrastructure & DevOps"
            echo "- [ ] Helm chart best practices followed"
            echo "- [ ] Kubernetes manifests validated (helm lint, kubectl dry-run)"
            echo "- [ ] Docker best practices followed (multi-stage builds, security)"
            echo "- [ ] Resource limits and requests configured"
            echo "- [ ] Deployment tested in staging"
            echo ""
            echo "## ðŸ“ Recent Commits"
            echo ""
            # Show last 5 commits on current branch (handle missing main branch)
            if git rev-parse --verify origin/main >/dev/null 2>&1; then
              git log --oneline --no-decorate -5 "$BRANCH_NAME" ^origin/main
            else
              git log --oneline --no-decorate -5 "$BRANCH_NAME"
            fi
            echo ""
            echo "---"
            echo ""
            echo "**ðŸ” Copilot AI Review**: Automated compliance and security validation will run on this PR."
            echo ""
            echo "**ðŸ“š Guidelines**: See \`.github/copilot-instructions.md\` for complete review criteria."
            echo ""
            echo "**Auto-generated by** \`.github/workflows/auto-pr-to-main.yml\`"
          } > "$PR_BODY"
          
          # Create PR with dynamic title and body
          pr_url=$(gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$(cat "$PR_TITLE")" \
            --body-file "$PR_BODY")
          
          # Extract PR number from URL
          pr_number=$(echo "$pr_url" | grep -oE '[0-9]+$')
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "Created PR #$pr_number"
          echo "Note: Copilot auto-review will be triggered by Repository Ruleset"
          
          # Cleanup
          rm -f "$PR_BODY" "$PR_TITLE"
