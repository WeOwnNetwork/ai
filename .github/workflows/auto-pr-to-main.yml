name: Auto-Create PR to Main

on:
  push:
    branches:
      - '*'
      - '!main'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get current branch name
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Check if PR already exists
          existing_pr=$(gh pr list --base main --head "$BRANCH_NAME" --json number --jq '.[0].number')
          
          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists, new commits will be added automatically"
            echo "pr_number=$existing_pr" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create PR body and title files
          PR_BODY=$(mktemp)
          PR_TITLE=$(mktemp)
          
          # Generate dynamic title from first commit
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            FIRST_COMMIT=$(git log --format=%s -1 "$BRANCH_NAME" ^origin/main)
          else
            FIRST_COMMIT=$(git log --format=%s -1 "$BRANCH_NAME")
          fi
          
          # Fallback if no unique commits are found or subject is empty
          if [ -z "$FIRST_COMMIT" ]; then
            FIRST_COMMIT="Updates from $BRANCH_NAME"
          fi
          
          # Create title: "Auto-PR: <first commit subject>"
          echo "Auto-PR: $FIRST_COMMIT" > "$PR_TITLE"
          
          {
            echo "ðŸ¤– Automated Pull Request"
            echo ""
            echo "## ðŸ“‹ Human-in-the-Loop Review Checklist"
            echo ""
            echo "**Review the following before approving this PR:**"
            echo ""
            echo "### Security & Compliance"
            echo "- [ ] All GitHub Copilot AI code review comments addressed"
            echo "- [ ] SOC2/ISO/IEC 42001 compliance requirements validated"
            echo "- [ ] Security best practices followed (no hardcoded secrets, proper RBAC, etc.)"
            echo "- [ ] No sensitive data in commits"
            echo "- [ ] TLS 1.3 configured where applicable"
            echo ""
            echo "### Code Quality & Testing"
            echo "- [ ] Code follows established conventions and style guides"
            echo "- [ ] All automated tests passing"
            echo "- [ ] No breaking changes (or migration plan documented)"
            echo "- [ ] Performance implications assessed"
            echo "- [ ] Error handling adequate"
            echo ""
            echo "### Documentation & Versioning"
            echo "- [ ] Documentation updated (README, CHANGELOG, inline comments)"
            echo "- [ ] Version numbers incremented appropriately"
            echo "- [ ] API changes documented"
            echo "- [ ] Architecture Decision Records (ADRs) created if applicable"
            echo ""
            echo "### Infrastructure & DevOps"
            echo "- [ ] Helm chart best practices followed"
            echo "- [ ] Kubernetes manifests validated (helm lint, kubectl dry-run)"
            echo "- [ ] Docker best practices followed (multi-stage builds, security)"
            echo "- [ ] Resource limits and requests configured"
            echo "- [ ] Deployment tested in staging"
            echo ""
            echo "## ðŸ“ Recent Commits"
            echo ""
            # Show last 5 commits on current branch (handle missing main branch)
            if git rev-parse --verify origin/main >/dev/null 2>&1; then
              git log --oneline --no-decorate -5 "$BRANCH_NAME" ^origin/main
            else
              git log --oneline --no-decorate -5 "$BRANCH_NAME"
            fi
            echo ""
            echo "---"
            echo ""
            echo "**ðŸ” Copilot AI Review**: Automated compliance and security validation will run on this PR."
            echo ""
            echo "**ðŸ“š Guidelines**: See \`.github/copilot-instructions.md\` for complete review criteria."
            echo ""
            echo "**Auto-generated by** \`.github/workflows/auto-pr-maintenance.yml\`"
          } > "$PR_BODY"
          
          # Create PR with dynamic title and body
          pr_url=$(gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$(cat "$PR_TITLE")" \
            --body-file "$PR_BODY")
          
          # Extract PR number from URL
          pr_number=$(echo "$pr_url" | grep -oE '[0-9]+$')
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "Created PR #$pr_number"
          echo "Note: Copilot auto-review will be triggered by Repository Ruleset"
          
          # Cleanup
          rm -f "$PR_BODY" "$PR_TITLE"
