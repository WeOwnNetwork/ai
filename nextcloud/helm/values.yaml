# Nextcloud Helm Chart Values

global:
  # Domain config
  domain: "DOMAIN_PLACEHOLDER"
  email: "EMAIL_PLACEHOLDER"
  
  # Image registry
  imageRegistry: ""
  imagePullSecrets: []

# Cert Manager
certManager:
  createClusterIssuer: false

# Backup
backup:
  enabled: true
  schedule: "0 2 * * *"
  retention: 30

# Nextcloud
nextcloud:
  image:
    repository: nextcloud
    tag: "latest"
    pullPolicy: IfNotPresent

  # Startup command
  command: ["/entrypoint.sh", "apache2-foreground"]
  
  # Admin credentials
  admin:
    user: "admin"
    password: "ADMIN_PASSWORD_PLACEHOLDER"

  # Deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1

  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
      ephemeral-storage: 1Gi

  # Pod Security Context
  podSecurityContext:
    fsGroup: 33
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop: ["ALL"]
      add: []
    readOnlyRootFilesystem: false

  # Health checks
  livenessProbe:
    httpGet:
      path: /status.php
      port: 80
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /status.php
      port: 80
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Environment
  config:
    # Core
    NEXTCLOUD_HOST: "DOMAIN_PLACEHOLDER"
    NEXTCLOUD_PROTOCOL: "https"
    NEXTCLOUD_PORT: "80"
    NEXTCLOUD_SECURE_COOKIE: "true"
    
    # Database
    POSTGRES_HOST: "postgresql"
    POSTGRES_DB: "nextcloud"
    POSTGRES_USER: "nextcloud"
    POSTGRES_PASSWORD: "POSTGRES_PASSWORD_PLACEHOLDER"
    
    # Redis
    REDIS_HOST: "redis"
    REDIS_HOST_PASSWORD: "REDIS_PASSWORD_PLACEHOLDER"
    
    # Nextcloud
    NEXTCLOUD_ADMIN_USER: "admin"
    NEXTCLOUD_ADMIN_PASSWORD: "ADMIN_PASSWORD_PLACEHOLDER"
    NEXTCLOUD_TRUSTED_DOMAINS: "DOMAIN_PLACEHOLDER"
    NEXTCLOUD_DATA_DIR: "/var/www/html/data"
    NEXTCLOUD_SECRET: "NEXTCLOUD_SECRET_PLACEHOLDER"
    
    # PHP
    PHP_MEMORY_LIMIT: "512M"
    PHP_UPLOAD_LIMIT: "512M"
    PHP_MAX_EXECUTION_TIME: "300"
    
    # Performance
    APCu_ENABLED: "true"
    OPcache_ENABLED: "true"
    REDIS_SESSION_LOCKING_ENABLED: "true"
    REDIS_FILE_LOCKING_ENABLED: "true"

  # Secrets
  secrets:
    NEXTCLOUD_ADMIN_PASSWORD: "ADMIN_PASSWORD_PLACEHOLDER"
    POSTGRES_PASSWORD: "POSTGRES_PASSWORD_PLACEHOLDER"
    POSTGRES_ROOT_PASSWORD: "POSTGRES_ROOT_PASSWORD_PLACEHOLDER"
    REDIS_PASSWORD: "REDIS_PASSWORD_PLACEHOLDER"
    NEXTCLOUD_SECRET: "NEXTCLOUD_SECRET_PLACEHOLDER"

  # Service configuration
  service:
    type: ClusterIP
    port: 80
    targetPort: 80

  # Storage
  persistence:
    enabled: true
    storageClass: "do-block-storage"
    accessMode: ReadWriteOnce
    
    # Volume types
    volumes:
      data:
        mountPath: /var/www/html/data
        size: 20Gi
      config:
        mountPath: /var/www/html/config
        size: 1Gi
      apps:
        mountPath: /var/www/html/custom_apps
        size: 2Gi

# PostgreSQL
postgresql:
  enabled: true
  image: postgres:15-alpine
  
  auth:
    database: nextcloud
    username: nextcloud
    password: "POSTGRES_PASSWORD_PLACEHOLDER"
    rootPassword: "POSTGRES_ROOT_PASSWORD_PLACEHOLDER"
  
  ## Security Context
  podSecurityContext:
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    fsGroup: 1001
    seccompProfile:
      type: RuntimeDefault
  
  containerSecurityContext:
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
      - ALL
    seccompProfile:
      type: RuntimeDefault
  
  ## Resources
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
      ephemeral-storage: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  
  ## Configuration
  configuration: |
    # Database config
    max_connections = 100
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 4MB
    min_wal_size = 1GB
    max_wal_size = 4GB

# Redis
redis:
  enabled: true
  image: redis:7-alpine
  auth:
    enabled: true
    password: "REDIS_PASSWORD_PLACEHOLDER"
  
  ## Resources
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
      ephemeral-storage: 200Mi
    requests:
      cpu: 50m
      memory: 64Mi
      ephemeral-storage: 100Mi
  
  persistence:
    enabled: false  # Disabled for performance in 2-node cluster
  
  ## Security Context
  podSecurityContext:
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    fsGroup: 1001
    seccompProfile:
      type: RuntimeDefault
  
  containerSecurityContext:
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
      - ALL
    seccompProfile:
      type: RuntimeDefault

# Ingress
ingress:
  enabled: true
  className: "nginx"
  
  annotations:
    # TLS and Security
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305"
    nginx.ingress.kubernetes.io/proxy-body-size: "512m"
    nginx.ingress.kubernetes.io/client-max-body-size: "512m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    
    # Security headers
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-burst: "20"
    
    # Cert management
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
  hosts:
    - host: "DOMAIN_PLACEHOLDER"
      paths:
        - path: /
          pathType: Prefix
  
  tls:
    - secretName: nextcloud-tls
      hosts:
        - "DOMAIN_PLACEHOLDER"

# Autoscaling
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Resource Quotas
resourceQuota:
  enabled: true
  requests:
    cpu: "2"
    memory: "4Gi"
  limits:
    cpu: "4"
    memory: "8Gi"
  persistentvolumeclaims: "10"
  secrets: "20"
  configmaps: "20"
  services: "10"
  pods: "10"

limitRange:
  enabled: true
  default:
    cpu: "500m"
    memory: "1Gi"
  defaultRequest:
    cpu: "100m"
    memory: "256Mi"
  max:
    cpu: "2"
    memory: "4Gi"
    storage: "50Gi"
  min:
    cpu: "50m"
    memory: "128Mi"
    storage: "1Gi"

# NetworkPolicy
networkPolicy:
  enabled: true
  
  # Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80
    # Allow same-namespace communication for cron jobs
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 80
  
  # Egress
  egress:
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # HTTPS for external services
    - to: []
      ports:
        - protocol: TCP
          port: 443
    # HTTP for specific integrations (optional)
    - to: []
      ports:
        - protocol: TCP
          port: 80
    # Database connections
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - protocol: TCP
          port: 5432
    # Redis connections  
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379

# ServiceMonitor for Prometheus (optional)
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s

# RBAC
rbac:
  create: true
  
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Node settings
affinity: {}
nodeSelector: {}
tolerations: []

# Cron Jobs
cron:
  enabled: true
  schedule: "*/5 * * * *"
  image:
    repository: nextcloud
    tag: latest
  resources:
    limits:
      cpu: 100m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

# Migration tools (for data import)
migration:
  enabled: false
  # Init container for data migration
  image:
    repository: busybox
    tag: latest
  # Migration job configuration  
  job:
    enabled: false
    backoffLimit: 3
