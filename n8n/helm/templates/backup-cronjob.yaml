{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "n8n.fullname" . }}-backup
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "n8n.labels" . | nindent 4 }}
    component: backup
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "n8n.selectorLabels" . | nindent 12 }}
            component: backup
        spec:
          restartPolicy: OnFailure
          # Force backup to run on same node as main n8n pod (RWO volume requirement)
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: app.kubernetes.io/name
                        operator: In
                        values:
                          - n8n
                      - key: component
                        operator: In
                        values:
                          - main
                  topologyKey: kubernetes.io/hostname
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
          - name: backup
            image: busybox:1.36
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting n8n backup at $(date)"
              
              # Create backup directory
              mkdir -p /backup/$(date +%Y%m%d_%H%M%S)
              
              # Copy n8n data
              if [ -d "/data" ]; then
                cp -r /data/* /backup/$(date +%Y%m%d_%H%M%S)/ || true
                echo "Backup completed successfully at $(date)"
              else
                echo "No data directory found"
              fi
              
              # Cleanup old backups (keep last {{ .Values.backup.retention }} days)
              find /backup -type d -name "20*" -mtime +{{ .Values.backup.retention }} -exec rm -rf {} + || true
              
              echo "Backup job finished at $(date)"
            volumeMounts:
            - name: n8n-data
              mountPath: /data
            - name: backup-storage
              mountPath: /backup
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 128Mi
          volumes:
          - name: n8n-data
            persistentVolumeClaim:
              claimName: {{ include "n8n.fullname" . }}-data
          - name: backup-storage
            persistentVolumeClaim:
              claimName: {{ include "n8n.fullname" . }}-backup
{{- end }}
