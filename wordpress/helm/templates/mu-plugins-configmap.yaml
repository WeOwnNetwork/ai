apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-mu-plugins
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
    app.kubernetes.io/component: mu-plugins
data:
  {{- if .Values.muPlugins.cache.enabled }}
  wp-enterprise-cache.php: |
    <?php
    /*
    Plugin Name: Enterprise Cache Headers
    Description: Adds enterprise-grade cache headers for WordPress
    Version: 1.0.0
    */

    if (!defined('ABSPATH')) {
        exit;
    }

    class EnterpriseCache {
        public function __construct() {
            add_action('template_redirect', array($this, 'add_cache_headers'), 1);
            add_action('wp_cron_schedules', array($this, 'add_cron_schedules'));
        }

        public function add_cache_headers() {
            if (is_admin() || is_user_logged_in() || is_feed()) {
                return;
            }

            $cache_time = 3600; // 1 hour

            if (is_front_page() || is_home()) {
                $cache_time = 1800; // 30 minutes for homepage
            } elseif (is_single() || is_page()) {
                $cache_time = 86400; // 24 hours for posts/pages
            }

            // Set cache headers
            header('Cache-Control: public, max-age=' . $cache_time);
            header('Expires: ' . gmdate('D, d M Y H:i:s', time() + $cache_time) . ' GMT');
            header('Last-Modified: ' . gmdate('D, d M Y H:i:s', get_the_modified_time('U')) . ' GMT');
            header('ETag: "' . md5(get_the_modified_time('U') . $_SERVER['REQUEST_URI']) . '"');
            header('Vary: Accept-Encoding');
        }

        public function add_cron_schedules($schedules) {
            $schedules['every_15_minutes'] = array(
                'interval' => 900,
                'display' => 'Every 15 Minutes'
            );
            return $schedules;
        }
    }

    new EnterpriseCache();

    // Fix for scheduled events
    if (!wp_next_scheduled('wp_privacy_delete_old_export_files')) {
        wp_schedule_event(time(), 'daily', 'wp_privacy_delete_old_export_files');
    }
  {{- end }}

  {{- if .Values.muPlugins.authFix.enabled }}
  platform-rest-api-auth-fix.php: |
    <?php
    /**
     * Plugin Name: Platform REST API Auth Fix
     * Description: Ensures Application Password authentication works correctly in containerized environments (Nginx/K8s)
     * Version: 1.0.0
     * Author: WeOwn
     */

    add_filter('determine_current_user', 'platform_fix_app_password_user', 20);

    function platform_fix_app_password_user($user_id) {
        // If user already determined, return it
        if ($user_id) {
            return $user_id;
        }
        
        // Only process REST API requests
        if (!defined('REST_REQUEST') || !REST_REQUEST) {
            return $user_id;
        }
        
        // Check if this is Application Password authentication
        if (empty($_SERVER['PHP_AUTH_USER']) || empty($_SERVER['PHP_AUTH_PW'])) {
            return $user_id;
        }
        
        // Get the authenticated user from Application Password
        $authenticated_user = wp_authenticate_application_password(null, $_SERVER['PHP_AUTH_USER'], $_SERVER['PHP_AUTH_PW']);
        
        if (is_wp_error($authenticated_user)) {
            return $user_id;
        }
        
        // Set the current user for get_current_user_id()
        if ($authenticated_user instanceof WP_User) {
            return $authenticated_user->ID;
        }
        
        return $user_id;
    }
  {{- end }}

  {{- if .Values.muPlugins.disableXmlRpc.enabled }}
  disable-xmlrpc.php: |
    <?php
    /**
     * Plugin Name: Disable XML-RPC
     * Description: Disables XML-RPC for security performance. Use REST API instead.
     * Version: 1.0.0
     */

    // Disable XML-RPC
    add_filter('xmlrpc_enabled', '__return_false');

    // Remove XML-RPC link from header
    remove_action('wp_head', 'rsd_link');

    // Disable pingbacks
    add_filter('xmlrpc_methods', function($methods) {
        unset($methods['pingback.ping']);
        return $methods;
    });
  {{- end }}

  {{- if .Values.muPlugins.smtp.enabled }}
  enterprise-smtp-config.php: |
    <?php
    /**
     * Plugin Name: Enterprise SMTP Configuration
     * Description: Configures SMTP settings via Environment Variables for reliable email delivery in Kubernetes
     * Version: 1.0.0
     */

    add_action('phpmailer_init', 'enterprise_smtp_config');

    function enterprise_smtp_config($phpmailer) {
        // Only configure if SMTP_HOST is defined (via wp-config.php or env)
        if (!defined('SMTP_HOST') && !getenv('SMTP_HOST')) {
            return;
        }

        $phpmailer->isSMTP();
        $phpmailer->Host       = defined('SMTP_HOST') ? SMTP_HOST : getenv('SMTP_HOST');
        $phpmailer->Port       = defined('SMTP_PORT') ? SMTP_PORT : (getenv('SMTP_PORT') ?: 587);
        $phpmailer->Username   = defined('SMTP_USER') ? SMTP_USER : getenv('SMTP_USER');
        $phpmailer->Password   = defined('SMTP_PASS') ? SMTP_PASS : getenv('SMTP_PASS');
        $phpmailer->SMTPSecure = defined('SMTP_SECURE') ? SMTP_SECURE : (getenv('SMTP_SECURE') ?: 'tls');
        $phpmailer->SMTPAuth   = true;

        // Auto-configure From address if set
        if (defined('SMTP_FROM_EMAIL') || getenv('SMTP_FROM_EMAIL')) {
            $phpmailer->From = defined('SMTP_FROM_EMAIL') ? SMTP_FROM_EMAIL : getenv('SMTP_FROM_EMAIL');
        }
        
        if (defined('SMTP_FROM_NAME') || getenv('SMTP_FROM_NAME')) {
            $phpmailer->FromName = defined('SMTP_FROM_NAME') ? SMTP_FROM_NAME : getenv('SMTP_FROM_NAME');
        }
    }
  {{- end }}
