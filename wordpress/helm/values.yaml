# WordPress Enterprise Configuration
# Enhanced security, resource optimization, and user experience

## Global Configuration
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: "do-block-storage"

## Service Account Security
serviceAccount:
  create: true
  automount: false
  annotations: {}

# Pod Security Standards: Service Account Token Automount
automountServiceAccountToken: false

## Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  maxUnavailable: 1

## cert-manager Configuration
certManager:
  email: "EMAIL_PLACEHOLDER"
  createClusterIssuer: false  # Use existing ClusterIssuer

## WordPress Auto-Configuration
wordpressAutoConfig:
  enabled: true
  skipInstallation: true
  language: "en_US"
  enableMultisite: false

## Zero-Trust NetworkPolicy (Enterprise Security)
networkPolicy:
  enabled: true
  policyTypes:
  - Ingress
  - Egress
  
  # Ingress: Only allow NGINX Ingress Controller and same namespace
  ingress:
  - from:
    # Allow NGINX Ingress Controller
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    # Allow same namespace communication
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: wordpress
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
  
  # Egress: Restricted to essential services only
  egress:
  # DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # HTTPS for WordPress updates and plugins
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow communication with MariaDB and Redis in same namespace
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: wordpress
    ports:
    - protocol: TCP
      port: 3306  # MariaDB
    - protocol: TCP
      port: 6379  # Redis

## Replica Configuration
replicaCount: 1

## WordPress Configuration
wordpress:
  image:
    registry: docker.io
    repository: wordpress
    tag: "6.4.3-php8.3-apache"
    pullPolicy: IfNotPresent
    pullSecrets: []

  ## WordPress Admin User (Generated automatically)
  wordpressUsername: admin
  wordpressEmail: EMAIL_PLACEHOLDER
  wordpressPassword: "WORDPRESS_PASSWORD_PLACEHOLDER"

  ## WordPress Site Configuration
  wordpressBlogName: "Enterprise WordPress Site"
  wordpressScheme: https
  
  ## WordPress Auto-Configuration (Skip Installation Wizard)
  wordpressSkipInstall: "yes"
  ## WordPress Extra WP Config Content
  wordpressExtraWpConfigContent: |
    // Auto-configuration to skip installation wizard
    define('WP_DEBUG', false);
    define('WP_DEBUG_LOG', false);
    define('WP_DEBUG_DISPLAY', false);
    define('AUTOMATIC_UPDATER_DISABLED', false);
    define('WP_AUTO_UPDATE_CORE', 'minor');
    define('DISALLOW_FILE_EDIT', true);
    define('FORCE_SSL_ADMIN', true);
    define('WP_MEMORY_LIMIT', '256M');
    
    // Disable WP-Cron (handled by Kubernetes CronJob)
    define('DISABLE_WP_CRON', true);
    
    // Performance optimizations
    define('WP_CACHE', true);
    define('WP_POST_REVISIONS', 3);
    define('AUTOSAVE_INTERVAL', 300);
    define('EMPTY_TRASH_DAYS', 7);
    
    // Security hardening
    ini_set('session.cookie_httponly', true);
    ini_set('session.cookie_secure', true);
    ini_set('session.use_only_cookies', true);
    
    // Enable object caching
    define('WP_CACHE_KEY_SALT', 'wordpress_cache_');
    
    // SMTP Configuration for reliable email delivery
    define('SMTP_FROM_EMAIL', 'roman@weown.email');
    define('SMTP_FROM_NAME', 'Roman DiDomizio');
    
    // Enable WordPress mail debug logging
    define('WP_MAIL_DEBUG', false);
  
  ## WordPress Security Keys (Generated automatically by deployment script)
  security:
    authKey: "AUTH_KEY_PLACEHOLDER"
    secureAuthKey: "SECURE_AUTH_KEY_PLACEHOLDER"
    loggedInKey: "LOGGED_IN_KEY_PLACEHOLDER"
    nonceKey: "NONCE_KEY_PLACEHOLDER"
    authSalt: "AUTH_SALT_PLACEHOLDER"
    secureAuthSalt: "SECURE_AUTH_SALT_PLACEHOLDER"
    loggedInSalt: "LOGGED_IN_SALT_PLACEHOLDER"
    nonceSalt: "NONCE_SALT_PLACEHOLDER"

  ## Persistence Configuration
  persistence:
    enabled: true
    storageClass: "do-block-storage"
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    coreSize: 4Gi  # WordPress core files persistence
    # Separate volumes for security
    volumes:
      content:
        mountPath: /var/www/html/wp-content
        size: 8Gi
      config:
        mountPath: /var/www/html/wp-config-custom
        size: 100Mi
      cache:
        mountPath: /var/cache/wordpress
        size: 1Gi

  ## Extra environment variables
  extraEnvVars:
  - name: WORDPRESS_ENABLE_REDIS
    value: "yes"  # Enable Redis since we re-enabled it
  - name: APACHE_HTTP_PORT
    value: "8080"
  - name: WORDPRESS_CONFIG_EXTRA
    value: |
      define('WP_CACHE', true);
      define('DISABLE_FILE_EDITING', true);
      define('DISALLOW_FILE_MODS', true);
      define('FORCE_SSL_ADMIN', true);
      define('WP_AUTO_UPDATE_CORE', true);

  ## Init Containers (WordPress Hardening) - Disabled for resource optimization
  initContainers:
    enabled: false
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      runAsNonRoot: true

  ## WordPress Security Context (Production Ready)
  security:
    automountServiceAccountToken: false
    runAsUser: 0  # Required for Apache port 80 binding
    runAsGroup: 0
    runAsNonRoot: false
    fsGroup: 33  # www-data for file permissions
    readOnlyRootFilesystem: false
    allowPrivilegeEscalation: false
    capabilities: {}  # Use default capabilities for WordPress
    seccompProfile:
      type: RuntimeDefault

  ## Resource Configuration (WordPress Production Requirements)
  resources:
    limits:
      cpu: 400m        # Increased for plugin installations and intensive operations
      memory: 1Gi      # Increased to handle plugin installations without OOMKilled
      ephemeral-storage: 400Mi
    requests:
      cpu: 25m         # Reduced from 50m (CPU underutilized)
      memory: 96Mi      # Reduced from 128Mi based on actual 117-134Mi usage
      ephemeral-storage: 200Mi

  ## Auto-scaling Configuration (Disabled for single replica + RWO volumes)
  autoscaling:
    enabled: false  # Must be false when using ReadWriteOnce volumes
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  ## Health Checks
  livenessProbe:
    enabled: true
    httpGet:
      path: /
      port: http
      httpHeaders:
      - name: Host
        value: "DOMAIN_PLACEHOLDER"
    initialDelaySeconds: 120
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 6
    successThreshold: 1

  readinessProbe:
    enabled: true
    httpGet:
      path: /wp-login.php
      port: http
      httpHeaders:
      - name: Host
        value: "DOMAIN_PLACEHOLDER"
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 10
    failureThreshold: 6
    successThreshold: 1

## WordPress Cron Configuration
cron:
  enabled: true


## MariaDB Configuration (Resource Optimized)
mariadb:
  enabled: true
  image:
    tag: "11.1-debian-12"  # MariaDB 11.1 - much more memory efficient than MySQL
  auth:
    rootPassword: "MARIADB_ROOT_PASSWORD_PLACEHOLDER"
    password: "MARIADB_PASSWORD_PLACEHOLDER"
    database: wordpress
    username: wordpress
  architecture: standalone
  
  persistence:
    enabled: true
    accessMode: ReadWriteOnce
    size: 8Gi
    configSize: 1Gi
    cacheSize: 2Gi
    coreSize: 4Gi
  
  ## MariaDB Security (Pod Security Standards: Restricted)
  podSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    fsGroup: 1001
    seccompProfile:
      type: RuntimeDefault
  
  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false  # MariaDB needs write access
    capabilities:
      drop:
      - ALL
    seccompProfile:
      type: RuntimeDefault
  
  ## Resource Configuration (MariaDB Memory-Optimized)
  resources:
    limits:
      cpu: 250m        # Updated to match cluster optimization
      memory: 256Mi    # Updated to match cluster optimization (90-130Mi actual usage)
      ephemeral-storage: 200Mi
    requests:
      cpu: 50m         # Updated to match cluster optimization
      memory: 128Mi    # Updated to match cluster optimization
      ephemeral-storage: 100Mi
  
  ## MariaDB Performance Tuning (2-node cluster optimized)
  configuration: |
    [mysqld]
    max_connections=20        # Further reduced for efficiency
    innodb_buffer_pool_size=64M   # Reduced for memory efficiency
    innodb_log_file_size=16M  # Reduced for faster startup
    query_cache_size=16M      # Reduced but still beneficial
    query_cache_limit=1M      # Conservative limit
    thread_cache_size=4       # Fewer threads for 2-node
    table_open_cache=128      # Reduced cache size
    performance_schema=OFF    # Keep disabled for efficiency
    innodb_flush_log_at_trx_commit=2  # Better performance

## Redis Cache Configuration (Lightweight for 2-node cluster)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: "REDIS_PASSWORD_PLACEHOLDER"
  
  ## Resource limits for 2-node efficiency
  master:
    resources:
      limits:
        cpu: 50m
        memory: 48Mi
        ephemeral-storage: 150Mi
      requests:
        cpu: 10m
        memory: 24Mi
        ephemeral-storage: 50Mi
    
    persistence:
      enabled: false  # Disabled for performance in 2-node cluster
    
    ## Security context for Redis
    podSecurityContext:
      enabled: true
      runAsUser: 1001
      runAsGroup: 1001
      runAsNonRoot: true
      fsGroup: 1001
      seccompProfile:
        type: RuntimeDefault
    
    containerSecurityContext:
      enabled: true
      runAsUser: 1001
      runAsGroup: 1001
      runAsNonRoot: true
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
        - ALL
      seccompProfile:
        type: RuntimeDefault

## Service Configuration
service:
  type: ClusterIP  # Secure internal-only access
  port: 80
  targetPort: 80
  annotations: {}

## Ingress Configuration (Enterprise Security + TLS 1.3)
ingress:
  enabled: true
  className: nginx
  annotations:
    # TLS Certificate Management
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Force HTTPS and SSL
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    # Performance and security limits
    nginx.ingress.kubernetes.io/proxy-body-size: "64m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    # Rate limiting for DDoS protection
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-connections: "20"
  
  hosts:
  - host: DOMAIN_PLACEHOLDER
    paths:
    - path: /
      pathType: Prefix
  
  tls:
  - secretName: wordpress-tls
    hosts:
    - DOMAIN_PLACEHOLDER

## NetworkPolicy (Zero-Trust Security)
networkPolicy:
  enabled: true
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
    # Allow NGINX Ingress Controller
    - from:
      - namespaceSelector:
          matchLabels:
            name: ingress-nginx
      - podSelector:
          matchLabels: {}
      ports:
      - protocol: TCP
        port: 8080
  egress:
    # Allow DNS resolution to kube-system namespace only
    - to:
      - namespaceSelector:
          matchLabels:
            name: kube-system
      ports:
      - protocol: UDP
        port: 53
      - protocol: TCP
        port: 53
    # Allow HTTPS outbound for WordPress updates/plugins
    - to: []
      ports:
      - protocol: TCP
        port: 443
    # Allow access to MariaDB
    - to:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: mariadb
      ports:
      - protocol: TCP
        port: 3306
    # Allow access to Redis (if enabled)
    - to:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: redis
      ports:
      - protocol: TCP
        port: 6379

## Backup Configuration (NEW - Enhanced Data Protection)
backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention: 30  # Keep 30 days of backups
  storage:
    size: 20Gi
    storageClass: "do-block-storage"

## Monitoring & Observability
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    path: /wp-json/wp/v2/
    port: http

## WordPress Plugins (Pre-configured)
plugins:
  security:
    - wordfence  # Security plugin
    - limit-login-attempts  # Brute force protection
  performance:
    - w3-total-cache  # Caching
    - smush  # Image optimization
  fluent:
    - fluentcrm  # CRM integration
    - fluentform  # Form builder
    - fluent-boards  # Project management
